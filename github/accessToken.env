// github/githubAccess.js
const fetch = require('node-fetch');

const GITHUB_OWNER = process.env.GITHUB_OWNER; // e.g., "yourusername"
const GITHUB_REPO = process.env.GITHUB_REPO;   // e.g., "AppRaR-Free"
const GITHUB_PATH = process.env.GITHUB_PATH;   // e.g., "data/free-apps.json"
const GITHUB_TOKEN = process.env.GITHUB_TOKEN; // your personal access token

/**
 * Get current free apps JSON from GitHub
 */
async function fetchFreeApps() {
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;
    const res = await fetch(url, {
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3.raw'
        }
    });
    if (!res.ok) throw new Error(`GitHub fetch failed: ${res.statusText}`);
    const data = await res.json();
    return JSON.parse(Buffer.from(data.content, 'base64').toString('utf-8'));
}

/**
 * Update free apps JSON on GitHub
 * @param {array} jsonData - updated free apps array
 * @param {string} commitMessage
 */
async function updateFreeApps(jsonData, commitMessage = "Update free apps JSON") {
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;

    // Get current file SHA for updating
    const resGet = await fetch(url, {
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    const dataGet = await resGet.json();
    const sha = dataGet.sha;

    const content = Buffer.from(JSON.stringify(jsonData, null, 2)).toString('base64');

    const resPut = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
            message: commitMessage,
            content,
            sha
        })
    });

    if (!resPut.ok) throw new Error(`GitHub update failed: ${resPut.statusText}`);
    const result = await resPut.json();
    console.log("Free apps JSON updated on GitHub:", result.commit.sha);
    return result;
}

module.exports = { fetchFreeApps, updateFreeApps };